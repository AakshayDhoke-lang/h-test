<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messages | HostelComplaint</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
    <header>
        <div class="container">
            <nav>
                <div class="logo">
                    <i class="fas fa-building"></i>
                    <span>HostelComplaint</span>
                </div>

                <div class="nav-links">
                    <a href="#" class="nav-link" id="dashboard-link">
                        <i class="fas fa-home"></i> Dashboard
                    </a>
                    <a href="complaints.html" class="nav-link">
                        <i class="fas fa-list"></i> Complaints
                    </a>
                    <a href="messages.html" class="nav-link active">
                        <i class="fas fa-comments"></i> Messages
                        <span class="notification-badge hidden" id="message-notification">0</span>
                    </a>
                    <div class="user-info">
                        <i class="fas fa-user-circle"></i>
                        <span id="current-user-name">Loading...</span>
                    </div>
                    <button id="logout-btn" class="btn btn-secondary">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </nav>
        </div>
    </header>

    <main>
        <div class="container">
            <div class="page-header">
                <h1>Messages</h1>
                <p>Communicate with hostel staff about your complaints</p>
            </div>

            <div class="messages-container">
                <div class="conversations-sidebar">
                    <div class="conversations-header">
                        <h3>Conversations</h3>
                    </div>
                    <div class="conversations-list" id="conversations-list">
                        <!-- Conversations will be populated here -->
                    </div>
                </div>

                <div class="chat-container">
                    <div class="chat-header" id="chat-header">
                        <h3>Select a conversation</h3>
                    </div>

                    <div class="chat-messages" id="chat-messages">
                        <div class="no-chat-selected">
                            <p>Select a conversation from the list to view messages</p>
                        </div>
                    </div>

                    <div class="chat-input hidden" id="chat-input">
                        <textarea id="message-input" placeholder="Type your message here..." rows="2"></textarea>
                        <button id="send-message-btn" class="btn btn-primary">
                            <i class="fas fa-paper-plane"></i> Send
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="js/database.js"></script>
    <script src="js/auth.js"></script>
    <script>
        let currentChatId = null;
        let currentUser = null;

        document.addEventListener('DOMContentLoaded', function() {
            // Check authentication
            currentUser = checkAuth();
            document.getElementById('current-user-name').textContent = currentUser.name;

            // Set dashboard link based on role
            const dashboardLink = document.getElementById('dashboard-link');
            dashboardLink.href = currentUser.role === 'student' ? 'student-dashboard.html' : 'warden-dashboard.html';

            // Load conversations
            loadConversations();

            // Setup event listeners
            document.getElementById('logout-btn').addEventListener('click', logout);
            document.getElementById('send-message-btn').addEventListener('click', sendMessage);
            document.getElementById('message-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // Update notification badge
            updateNotificationBadge();

            // Poll for new messages every 10 seconds
            setInterval(updateConversations, 10000);
        });

        function loadConversations() {
            const conversationsList = document.getElementById('conversations-list');
            conversationsList.innerHTML = '';

            const messages = getMessages();
            const complaints = getComplaints();
            const users = getUsers();

            // Group messages by complaint
            const conversations = {};

            messages.forEach(message => {
                if (!conversations[message.complaintId]) {
                    const complaint = getComplaintById(message.complaintId);
                    if (!complaint) return;

                    // Check if user is part of this conversation
                    if (currentUser.role === 'student' && complaint.studentId !== currentUser.id) {
                        return;
                    }
                    if (currentUser.role === 'staff' && complaint.assignedTo !== currentUser.id) {
                        return;
                    }
                    if (currentUser.role === 'warden') {
                        // Warden can see all conversations
                    }

                    conversations[message.complaintId] = {
                        complaint: complaint,
                        lastMessage: message,
                        unreadCount: 0,
                        participants: {}
                    };
                }

                const conv = conversations[message.complaintId];

                // Track last message
                if (new Date(message.timestamp) > new Date(conv.lastMessage.timestamp)) {
                    conv.lastMessage = message;
                }

                // Count unread messages for current user
                if (message.receiverId === currentUser.id && message.status === 'unread') {
                    conv.unreadCount++;
                }

                // Add participants
                conv.participants[message.senderId] = message.senderName;
                conv.participants[message.receiverId] = message.receiverName;
            });

            // Convert to array and sort by last message time
            const sortedConversations = Object.values(conversations)
                .sort((a, b) => new Date(b.lastMessage.timestamp) - new Date(a.lastMessage.timestamp));

            // Display conversations
            if (sortedConversations.length === 0) {
                conversationsList.innerHTML = `
                    <div class="conversation-item">
                        <p class="text-center">No conversations yet</p>
                    </div>
                `;
                return;
            }

            sortedConversations.forEach(conv => {
                        const complaint = conv.complaint;
                        const lastMessage = conv.lastMessage;
                        const otherParticipants = Object.entries(conv.participants)
                            .filter(([id, name]) => parseInt(id) !== currentUser.id)
                            .map(([id, name]) => name)
                            .join(', ');

                        const item = document.createElement('div');
                        item.className = `conversation-item ${conv.unreadCount > 0 ? 'unread' : ''}`;
                        if (currentChatId === complaint.id) {
                            item.classList.add('active');
                        }

                        item.innerHTML = `
                    <div class="conversation-item-header">
                        <div class="conversation-user">${complaint.category} #${complaint.id}</div>
                        <div class="conversation-time">${formatTime(lastMessage.timestamp)}</div>
                    </div>
                    <div class="conversation-preview">
                        <strong>${lastMessage.senderName}:</strong> ${lastMessage.message.substring(0, 40)}${lastMessage.message.length > 40 ? '...' : ''}
                    </div>
                    ${conv.unreadCount > 0 ? `<span class="notification-badge">${conv.unreadCount}</span>` : ''}
                `;
                
                item.addEventListener('click', () => openChat(complaint.id));
                conversationsList.appendChild(item);
            });
        }
        
        function openChat(complaintId) {
            currentChatId = complaintId;
            const complaint = getComplaintById(complaintId);
            
            // Update chat header
            const chatHeader = document.getElementById('chat-header');
            chatHeader.innerHTML = `
                <h3>${complaint.category} - ${complaint.description.substring(0, 50)}...</h3>
                <small>Complaint #${complaint.id} â€¢ ${complaint.location}</small>
            `;
            
            // Show chat input
            document.getElementById('chat-input').classList.remove('hidden');
            
            // Load messages
            loadChatMessages(complaintId);
            
            // Mark messages as read
            markMessagesAsRead(complaintId, currentUser.id);
            
            // Update conversations list
            loadConversations();
            updateNotificationBadge();
        }
        
        function loadChatMessages(complaintId) {
            const chatMessages = document.getElementById('chat-messages');
            const messages = getMessagesByComplaint(complaintId)
                .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            
            chatMessages.innerHTML = '';
            
            if (messages.length === 0) {
                chatMessages.innerHTML = `
                    <div class="text-center">
                        <p>No messages yet. Start the conversation!</p>
                    </div>
                `;
                return;
            }
            
            messages.forEach(message => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${message.senderId === currentUser.id ? 'sent' : 'received'}`;
                
                messageDiv.innerHTML = `
                    <div class="message-header">
                        <span>${message.senderName}</span>
                        <span>${formatTime(message.timestamp)}</span>
                    </div>
                    <div class="message-content">${message.message}</div>
                `;
                
                chatMessages.appendChild(messageDiv);
            });
            
            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        function sendMessage() {
            if (!currentChatId) return;
            
            const input = document.getElementById('message-input');
            const messageText = input.value.trim();
            
            if (!messageText) return;
            
            const complaint = getComplaintById(currentChatId);
            
            // Determine receiver
            let receiverId, receiverName;
            if (currentUser.role === 'student') {
                if (complaint.assignedTo) {
                    receiverId = complaint.assignedTo;
                    receiverName = complaint.assignedName || getStaffMembers().find(s => s.id === complaint.assignedTo)?.name || 'Staff';
                } else {
                    // If no staff assigned, send to warden
                    const warden = getUsers().find(u => u.role === 'warden');
                    receiverId = warden.id;
                    receiverName = warden.name;
                }
            } else {
                // Staff/warden sending to student
                receiverId = complaint.studentId;
                receiverName = complaint.studentName;
            }
            
            // Add message
            addMessage({
                complaintId: currentChatId,
                senderId: currentUser.id,
                senderName: currentUser.name,
                senderRole: currentUser.role,
                receiverId: receiverId,
                receiverName: receiverName,
                message: messageText
            });
            
            // Clear input and reload messages
            input.value = '';
            loadChatMessages(currentChatId);
            loadConversations();
        }
        
        function updateConversations() {
            loadConversations();
            if (currentChatId) {
                loadChatMessages(currentChatId);
            }
            updateNotificationBadge();
        }
        
        function updateNotificationBadge() {
            const unreadCount = getUnreadCount(currentUser.id);
            const badge = document.getElementById('message-notification');
            
            if (unreadCount > 0) {
                badge.textContent = unreadCount;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }
        
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 60) {
                return `${diffMins} min ago`;
            } else if (diffHours < 24) {
                return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
            } else if (diffDays < 7) {
                return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
            } else {
                return date.toLocaleDateString();
            }
        }
        
        function logout() {
            sessionStorage.removeItem('currentUser');
            window.location.href = 'index.html';
        }
    </script>
</body>

</html>
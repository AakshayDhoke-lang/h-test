<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics | HostelComplaint</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <header>
        <div class="container">
            <nav>
                <div class="logo">
                    <i class="fas fa-building"></i>
                    <span>HostelComplaint</span>
                </div>

                <div class="nav-links">
                    <a href="warden-dashboard.html" class="nav-link">
                        <i class="fas fa-home"></i> Dashboard
                    </a>
                    <a href="complaints.html" class="nav-link">
                        <i class="fas fa-list"></i> Complaints
                    </a>
                    <a href="messages.html" class="nav-link">
                        <i class="fas fa-comments"></i> Messages
                    </a>
                    <a href="analytics.html" class="nav-link active">
                        <i class="fas fa-chart-bar"></i> Analytics
                    </a>
                    <div class="user-info">
                        <i class="fas fa-user-tie"></i>
                        <span id="current-user-name">Loading...</span>
                    </div>
                    <button id="logout-btn" class="btn btn-secondary">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </nav>
        </div>
    </header>

    <main>
        <div class="container">
            <div class="page-header">
                <h1>Analytics & Reports</h1>
                <p>Performance metrics and insights for hostel maintenance</p>
            </div>

            <div class="analytics-grid">
                <div class="chart-container">
                    <h3 class="chart-title">Complaints by Category</h3>
                    <canvas id="category-chart" height="250"></canvas>
                </div>

                <div class="chart-container">
                    <h3 class="chart-title">Complaints by Status</h3>
                    <canvas id="status-chart" height="250"></canvas>
                </div>

                <div class="chart-container">
                    <h3 class="chart-title">Monthly Trend</h3>
                    <canvas id="trend-chart" height="250"></canvas>
                </div>

                <div class="chart-container">
                    <h3 class="chart-title">Resolution Time Distribution</h3>
                    <canvas id="resolution-chart" height="250"></canvas>
                </div>
            </div>

            <div class="row">
                <div class="col">
                    <div class="section">
                        <h2>Key Performance Indicators</h2>
                        <div class="kpi-grid">
                            <div class="kpi-card">
                                <div class="kpi-icon">
                                    <i class="fas fa-clock"></i>
                                </div>
                                <div class="kpi-content">
                                    <div class="kpi-value" id="avg-resolution-time">0</div>
                                    <div class="kpi-label">Avg. Resolution Time</div>
                                    <div class="kpi-subtext">Days</div>
                                </div>
                            </div>

                            <div class="kpi-card">
                                <div class="kpi-icon">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                                <div class="kpi-content">
                                    <div class="kpi-value" id="resolution-rate">0%</div>
                                    <div class="kpi-label">Resolution Rate</div>
                                    <div class="kpi-subtext">Last 30 days</div>
                                </div>
                            </div>

                            <div class="kpi-card">
                                <div class="kpi-icon">
                                    <i class="fas fa-star"></i>
                                </div>
                                <div class="kpi-content">
                                    <div class="kpi-value" id="satisfaction-score">0</div>
                                    <div class="kpi-label">Satisfaction Score</div>
                                    <div class="kpi-subtext">Out of 5</div>
                                </div>
                            </div>

                            <div class="kpi-card">
                                <div class="kpi-icon">
                                    <i class="fas fa-exclamation-triangle"></i>
                                </div>
                                <div class="kpi-content">
                                    <div class="kpi-value" id="overdue-rate">0%</div>
                                    <div class="kpi-label">Overdue Rate</div>
                                    <div class="kpi-subtext">> 7 days</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col">
                    <div class="section">
                        <h2>Top Issues This Month</h2>
                        <div class="table-container">
                            <table id="top-issues-table">
                                <thead>
                                    <tr>
                                        <th>Category</th>
                                        <th>Count</th>
                                        <th>Avg. Resolution</th>
                                        <th>Trend</th>
                                    </tr>
                                </thead>
                                <tbody id="top-issues-body">
                                    <!-- Will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="section">
                <h2>Staff Performance</h2>
                <div class="table-container">
                    <table id="staff-performance-table">
                        <thead>
                            <tr>
                                <th>Staff Member</th>
                                <th>Assigned</th>
                                <th>Resolved</th>
                                <th>In Progress</th>
                                <th>Avg. Time</th>
                                <th>Satisfaction</th>
                            </tr>
                        </thead>
                        <tbody id="staff-performance-body">
                            <!-- Will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="section">
                <div class="section-header">
                    <h2>Reports & Export</h2>
                </div>
                <div class="report-actions">
                    <button class="btn btn-primary" onclick="exportReport('monthly')">
                        <i class="fas fa-file-pdf"></i> Monthly Report
                    </button>
                    <button class="btn btn-secondary" onclick="exportReport('performance')">
                        <i class="fas fa-file-excel"></i> Performance Data
                    </button>
                    <button class="btn btn-secondary" onclick="exportReport('complaints')">
                        <i class="fas fa-file-csv"></i> All Complaints
                    </button>
                </div>
            </div>

            <!-- Database Management Section -->
            <div class="section">
                <div class="section-header">
                    <h2>Database Management</h2>
                </div>
                <div class="warning-message">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>Warning:</strong> These actions will permanently delete data and cannot be undone.
                </div>

                <div class="database-management">
                    <div class="clear-stats" id="current-stats">
                        <span class="stat-badge stat-total" id="total-count">Total: 0</span>
                        <span class="stat-badge stat-resolved" id="resolved-count">Resolved: 0</span>
                        <span class="stat-badge stat-old" id="old-count">Old (>30 days): 0</span>
                    </div>

                    <div class="clear-actions mt-2">
                        <button class="btn btn-warning" onclick="clearResolvedComplaintsWithConfirm()">
                            <i class="fas fa-broom"></i> Clear Resolved Complaints
                        </button>
                        <button class="btn btn-secondary" onclick="clearOldComplaintsWithConfirm(30)">
                            <i class="fas fa-calendar-times"></i> Clear Old (>30 days)
                        </button>
                        <button class="btn btn-danger" onclick="clearAllComplaintsWithConfirm()">
                            <i class="fas fa-trash-alt"></i> Clear ALL Complaints
                        </button>
                        <button class="btn btn-danger" onclick="resetDatabaseWithConfirm()" style="display: none;" id="reset-db-btn">
                            <i class="fas fa-database"></i> Reset Entire Database
                        </button>
                    </div>

                    <p class="text-muted mt-2"><small>
                        <i class="fas fa-info-circle"></i> 
                        "Resolved" includes complaints with status "Resolved" or "Closed".
                        "Old" includes complaints older than 30 days.
                    </small></p>
                </div>
            </div>
        </div>
    </main>

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="confirm-modal">
        <div class="confirm-modal-content">
            <h3><i class="fas fa-exclamation-triangle"></i> Confirm Action</h3>
            <p id="confirmMessage">Are you sure you want to perform this action?</p>
            <div class="clear-stats" id="confirmStats" style="display: none;">
                <span class="stat-badge stat-total" id="confirm-total-count">Total: 0</span>
                <span class="stat-badge stat-resolved" id="confirm-resolved-count">Resolved: 0</span>
                <span class="stat-badge stat-old" id="confirm-old-count">Old (>30 days): 0</span>
            </div>
            <div class="confirm-modal-actions">
                <button id="confirmCancel" class="btn btn-secondary">Cancel</button>
                <button id="confirmProceed" class="btn btn-danger">Yes, Proceed</button>
            </div>
        </div>
    </div>

    <script src="js/database.js"></script>
    <script src="js/auth.js"></script>
    <script>
        let charts = {};
        let pendingAction = null;

        document.addEventListener('DOMContentLoaded', function() {
            // Check authentication (warden only)
            const currentUser = requireAuth('warden');
            if (!currentUser) return;

            document.getElementById('current-user-name').textContent = currentUser.name;

            // Show reset database button only for admin
            if (currentUser.username === 'admin') {
                document.getElementById('reset-db-btn').style.display = 'inline-block';
            }

            // Load analytics
            loadAnalytics();

            // Logout button
            document.getElementById('logout-btn').addEventListener('click', function() {
                sessionStorage.removeItem('currentUser');
                window.location.href = 'index.html';
            });

            // Setup modal event listeners
            setupModal();
        });

        function loadAnalytics() {
            const complaints = getComplaints();
            const analytics = getAnalytics();
            const users = getUsers();

            // Calculate KPIs
            calculateKPIs(complaints);

            // Load charts
            loadCharts(complaints, analytics);

            // Load top issues
            loadTopIssues(complaints);

            // Load staff performance
            loadStaffPerformance(complaints, users);

            // Update current stats
            updateCurrentStats(complaints);
        }

        function calculateKPIs(complaints) {
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

            const recentComplaints = complaints.filter(c => new Date(c.createdAt) >= thirtyDaysAgo);
            const resolvedRecent = recentComplaints.filter(c => ['Resolved', 'Closed'].includes(c.status));

            // Average resolution time
            const resolvedComplaints = complaints.filter(c => ['Resolved', 'Closed'].includes(c.status));
            let totalDays = 0;
            resolvedComplaints.forEach(c => {
                if (c.resolvedAt) {
                    const created = new Date(c.createdAt);
                    const resolved = new Date(c.resolvedAt);
                    const days = Math.ceil((resolved - created) / (1000 * 60 * 60 * 24));
                    totalDays += days;
                }
            });
            const avgResolution = resolvedComplaints.length > 0 ? (totalDays / resolvedComplaints.length).toFixed(1) : 0;
            document.getElementById('avg-resolution-time').textContent = avgResolution;

            // Resolution rate
            const resolutionRate = recentComplaints.length > 0 ?
                Math.round((resolvedRecent.length / recentComplaints.length) * 100) :
                0;
            document.getElementById('resolution-rate').textContent = `${resolutionRate}%`;

            // Satisfaction score
            const feedbackComplaints = complaints.filter(c => c.feedback && c.feedback.rating);
            const avgRating = feedbackComplaints.length > 0 ?
                (feedbackComplaints.reduce((sum, c) => sum + c.feedback.rating, 0) / feedbackComplaints.length).toFixed(1) :
                0;
            document.getElementById('satisfaction-score').textContent = avgRating;

            // Overdue rate
            const overdueComplaints = complaints.filter(c => {
                if (['Resolved', 'Closed'].includes(c.status)) return false;
                const created = new Date(c.createdAt);
                const now = new Date();
                const days = Math.ceil((now - created) / (1000 * 60 * 60 * 24));
                return days > 7;
            });
            const overdueRate = complaints.length > 0 ?
                Math.round((overdueComplaints.length / complaints.length) * 100) :
                0;
            document.getElementById('overdue-rate').textContent = `${overdueRate}%`;
        }

        function loadCharts(complaints, analytics) {
            // Destroy existing charts
            Object.values(charts).forEach(chart => {
                if (chart) chart.destroy();
            });

            // Chart 1: Complaints by Category
            const categoryCounts = {};
            complaints.forEach(c => {
                categoryCounts[c.category] = (categoryCounts[c.category] || 0) + 1;
            });

            const ctx1 = document.getElementById('category-chart').getContext('2d');
            charts.categoryChart = new Chart(ctx1, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(categoryCounts),
                    datasets: [{
                        data: Object.values(categoryCounts),
                        backgroundColor: [
                            '#4361ee', '#7209b7', '#4cc9f0', '#f8961e', '#f72585',
                            '#38b000', '#ff9e00', '#9d4edd'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });

            // Chart 2: Complaints by Status
            const statusCounts = {};
            complaints.forEach(c => {
                statusCounts[c.status] = (statusCounts[c.status] || 0) + 1;
            });

            const ctx2 = document.getElementById('status-chart').getContext('2d');
            charts.statusChart = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: Object.keys(statusCounts),
                    datasets: [{
                        label: 'Number of Complaints',
                        data: Object.values(statusCounts),
                        backgroundColor: '#4361ee'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });

            // Chart 3: Monthly Trend
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const monthlyCounts = new Array(12).fill(0);

            complaints.forEach(c => {
                const month = new Date(c.createdAt).getMonth();
                monthlyCounts[month]++;
            });

            const ctx3 = document.getElementById('trend-chart').getContext('2d');
            charts.trendChart = new Chart(ctx3, {
                type: 'line',
                data: {
                    labels: monthNames,
                    datasets: [{
                        label: 'Complaints',
                        data: monthlyCounts,
                        borderColor: '#7209b7',
                        backgroundColor: 'rgba(114, 9, 183, 0.1)',
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // Chart 4: Resolution Time Distribution
            const resolutionTimes = [0, 0, 0, 0, 0]; // <1 day, 1-2, 3-5, 6-7, >7
            resolvedComplaints = complaints.filter(c => ['Resolved', 'Closed'].includes(c.status));

            resolvedComplaints.forEach(c => {
                if (c.resolvedAt) {
                    const created = new Date(c.createdAt);
                    const resolved = new Date(c.resolvedAt);
                    const days = Math.ceil((resolved - created) / (1000 * 60 * 60 * 24));

                    if (days < 1) resolutionTimes[0]++;
                    else if (days <= 2) resolutionTimes[1]++;
                    else if (days <= 5) resolutionTimes[2]++;
                    else if (days <= 7) resolutionTimes[3]++;
                    else resolutionTimes[4]++;
                }
            });

            const ctx4 = document.getElementById('resolution-chart').getContext('2d');
            charts.resolutionChart = new Chart(ctx4, {
                type: 'bar',
                data: {
                    labels: ['<1 day', '1-2 days', '3-5 days', '6-7 days', '>7 days'],
                    datasets: [{
                        label: 'Number of Complaints',
                        data: resolutionTimes,
                        backgroundColor: '#4cc9f0'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        function loadTopIssues(complaints) {
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

            const recentComplaints = complaints.filter(c => new Date(c.createdAt) >= thirtyDaysAgo);
            const categoryStats = {};

            recentComplaints.forEach(c => {
                if (!categoryStats[c.category]) {
                    categoryStats[c.category] = {
                        count: 0,
                        totalResolutionTime: 0,
                        resolvedCount: 0
                    };
                }
                categoryStats[c.category].count++;

                if (c.resolvedAt) {
                    const created = new Date(c.createdAt);
                    const resolved = new Date(c.resolvedAt);
                    const days = Math.ceil((resolved - created) / (1000 * 60 * 60 * 24));
                    categoryStats[c.category].totalResolutionTime += days;
                    categoryStats[c.category].resolvedCount++;
                }
            });

            // Convert to array and sort by count
            const sortedCategories = Object.entries(categoryStats)
                .sort((a, b) => b[1].count - a[1].count)
                .slice(0, 5);

            const tbody = document.getElementById('top-issues-body');
            tbody.innerHTML = '';

            sortedCategories.forEach(([category, stats]) => {
                const avgResolution = stats.resolvedCount > 0 ?
                    (stats.totalResolutionTime / stats.resolvedCount).toFixed(1) :
                    '-';

                const trend = stats.count > 5 ? '↗ High' : stats.count > 2 ? '→ Medium' : '↘ Low';

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${category}</td>
                    <td>${stats.count}</td>
                    <td>${avgResolution} days</td>
                    <td><span class="trend-badge">${trend}</span></td>
                `;
                tbody.appendChild(row);
            });
        }

        function loadStaffPerformance(complaints, users) {
            const staffMembers = users.filter(u => u.role === 'staff');
            const tbody = document.getElementById('staff-performance-body');
            tbody.innerHTML = '';

            staffMembers.forEach(staff => {
                const assignedComplaints = complaints.filter(c => c.assignedTo === staff.id);
                const resolvedComplaints = assignedComplaints.filter(c => ['Resolved', 'Closed'].includes(c.status));
                const inProgress = assignedComplaints.filter(c => c.status === 'In Progress').length;

                // Calculate average resolution time
                let totalDays = 0;
                let resolvedCount = 0;
                resolvedComplaints.forEach(c => {
                    if (c.resolvedAt) {
                        const created = new Date(c.createdAt);
                        const resolved = new Date(c.resolvedAt);
                        const days = Math.ceil((resolved - created) / (1000 * 60 * 60 * 24));
                        totalDays += days;
                        resolvedCount++;
                    }
                });
                const avgTime = resolvedCount > 0 ? (totalDays / resolvedCount).toFixed(1) : '-';

                // Calculate satisfaction
                const feedbackComplaints = resolvedComplaints.filter(c => c.feedback && c.feedback.rating);
                const avgRating = feedbackComplaints.length > 0 ?
                    (feedbackComplaints.reduce((sum, c) => sum + c.feedback.rating, 0) / feedbackComplaints.length).toFixed(1) :
                    '-';

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${staff.name}</td>
                    <td>${assignedComplaints.length}</td>
                    <td>${resolvedComplaints.length}</td>
                    <td>${inProgress}</td>
                    <td>${avgTime} days</td>
                    <td>${avgRating} / 5</td>
                `;
                tbody.appendChild(row);
            });
        }

        function exportReport(type) {
            let content = '';
            let filename = '';

            switch (type) {
                case 'monthly':
                    content = generateMonthlyReport();
                    filename = `monthly_report_${new Date().toISOString().split('T')[0]}.pdf`;
                    break;
                case 'performance':
                    content = generatePerformanceReport();
                    filename = `performance_data_${new Date().toISOString().split('T')[0]}.csv`;
                    break;
                case 'complaints':
                    content = generateComplaintsReport();
                    filename = `all_complaints_${new Date().toISOString().split('T')[0]}.csv`;
                    break;
            }

            // For simplicity, we'll create a text file download
            // In a real application, you would generate PDF/Excel files
            const blob = new Blob([content], {
                type: 'text/plain'
            });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        function generateMonthlyReport() {
            const complaints = getComplaints();
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            const recentComplaints = complaints.filter(c => new Date(c.createdAt) >= thirtyDaysAgo);

            let report = `MONTHLY MAINTENANCE REPORT\n`;
            report += `Generated: ${new Date().toLocaleDateString()}\n`;
            report += `Period: Last 30 days\n`;
            report += `Total Complaints: ${recentComplaints.length}\n\n`;

            report += `BY CATEGORY:\n`;
            const categoryCounts = {};
            recentComplaints.forEach(c => {
                categoryCounts[c.category] = (categoryCounts[c.category] || 0) + 1;
            });
            Object.entries(categoryCounts).forEach(([cat, count]) => {
                report += `  ${cat}: ${count}\n`;
            });

            report += `\nBY STATUS:\n`;
            const statusCounts = {};
            recentComplaints.forEach(c => {
                statusCounts[c.status] = (statusCounts[c.status] || 0) + 1;
            });
            Object.entries(statusCounts).forEach(([status, count]) => {
                report += `  ${status}: ${count}\n`;
            });

            return report;
        }

        function generatePerformanceReport() {
            const complaints = getComplaints();
            const users = getUsers();
            const staffMembers = users.filter(u => u.role === 'staff');

            let csv = 'Staff Name,Assigned,Resolved,In Progress,Avg Resolution Days,Avg Rating\n';

            staffMembers.forEach(staff => {
                const assignedComplaints = complaints.filter(c => c.assignedTo === staff.id);
                const resolvedComplaints = assignedComplaints.filter(c => ['Resolved', 'Closed'].includes(c.status));
                const inProgress = assignedComplaints.filter(c => c.status === 'In Progress').length;

                let totalDays = 0;
                let resolvedCount = 0;
                resolvedComplaints.forEach(c => {
                    if (c.resolvedAt) {
                        const created = new Date(c.createdAt);
                        const resolved = new Date(c.resolvedAt);
                        const days = Math.ceil((resolved - created) / (1000 * 60 * 60 * 24));
                        totalDays += days;
                        resolvedCount++;
                    }
                });
                const avgTime = resolvedCount > 0 ? (totalDays / resolvedCount).toFixed(1) : '0';

                const feedbackComplaints = resolvedComplaints.filter(c => c.feedback && c.feedback.rating);
                const avgRating = feedbackComplaints.length > 0 ?
                    (feedbackComplaints.reduce((sum, c) => sum + c.feedback.rating, 0) / feedbackComplaints.length).toFixed(1) :
                    '0';

                csv += `"${staff.name}",${assignedComplaints.length},${resolvedComplaints.length},${inProgress},${avgTime},${avgRating}\n`;
            });

            return csv;
        }

        function generateComplaintsReport() {
            const complaints = getComplaints();

            let csv = 'ID,Category,Description,Priority,Status,Location,Student,Assigned To,Created At,Resolved At,Resolution Days,Rating,Feedback\n';

            complaints.forEach(c => {
                const created = new Date(c.createdAt);
                const resolved = c.resolvedAt ? new Date(c.resolvedAt) : null;
                const resolutionDays = resolved ? Math.ceil((resolved - created) / (1000 * 60 * 60 * 24)) : '';
                const rating = c.feedback ? c.feedback.rating : '';
                const feedback = c.feedback ? `"${c.feedback.comments.replace(/"/g, '""')}"` : '';

                csv += `"${c.id}","${c.category}","${c.description.replace(/"/g, '""')}","${c.priority}","${c.status}","${c.location}","${c.studentName}","${c.assignedName || ''}","${created.toLocaleDateString()}","${resolved ? resolved.toLocaleDateString() : ''}",${resolutionDays},${rating},${feedback}\n`;
            });

            return csv;
        }

        // Database Management Functions
        function updateCurrentStats(complaints) {
            const total = complaints.length;
            const resolved = complaints.filter(c => ['Resolved', 'Closed'].includes(c.status)).length;
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            const old = complaints.filter(c => new Date(c.createdAt) < thirtyDaysAgo).length;

            document.getElementById('total-count').textContent = `Total: ${total}`;
            document.getElementById('resolved-count').textContent = `Resolved: ${resolved}`;
            document.getElementById('old-count').textContent = `Old (>30 days): ${old}`;
        }

        function setupModal() {
            const modal = document.getElementById('confirmModal');
            const cancelBtn = document.getElementById('confirmCancel');
            const proceedBtn = document.getElementById('confirmProceed');

            // Close modal when clicking outside
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    hideModal();
                }
            });

            cancelBtn.addEventListener('click', hideModal);
            proceedBtn.addEventListener('click', function() {
                if (pendingAction) {
                    pendingAction();
                }
                hideModal();
            });
        }

        function showModal(message, showStats = false, stats = {}) {
            const modal = document.getElementById('confirmModal');
            const messageEl = document.getElementById('confirmMessage');
            const statsEl = document.getElementById('confirmStats');

            messageEl.textContent = message;

            if (showStats) {
                statsEl.style.display = 'flex';
                document.getElementById('confirm-total-count').textContent = `Total: ${stats.total || 0}`;
                document.getElementById('confirm-resolved-count').textContent = `Resolved: ${stats.resolved || 0}`;
                document.getElementById('confirm-old-count').textContent = `Old (>30 days): ${stats.old || 0}`;
            } else {
                statsEl.style.display = 'none';
            }

            modal.style.display = 'flex';
        }

        function hideModal() {
            const modal = document.getElementById('confirmModal');
            modal.style.display = 'none';
            pendingAction = null;
        }

        function clearAllComplaintsWithConfirm() {
            const complaints = getComplaints();
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            const old = complaints.filter(c => new Date(c.createdAt) < thirtyDaysAgo).length;
            const resolved = complaints.filter(c => ['Resolved', 'Closed'].includes(c.status)).length;

            showModal(
                `Are you sure you want to delete ALL ${complaints.length} complaints? This action cannot be undone!`,
                true, {
                    total: complaints.length,
                    resolved: resolved,
                    old: old
                }
            );

            pendingAction = function() {
                if (clearAllComplaints()) {
                    alert('All complaints have been cleared successfully.');
                    loadAnalytics();
                }
            };
        }

        function clearResolvedComplaintsWithConfirm() {
            const complaints = getComplaints();
            const resolvedComplaints = complaints.filter(c => ['Resolved', 'Closed'].includes(c.status));
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            const oldResolved = resolvedComplaints.filter(c => new Date(c.createdAt) < thirtyDaysAgo).length;

            if (resolvedComplaints.length === 0) {
                alert('There are no resolved complaints to clear.');
                return;
            }

            showModal(
                `Are you sure you want to delete ${resolvedComplaints.length} resolved complaints?`,
                true, {
                    total: resolvedComplaints.length,
                    resolved: resolvedComplaints.length,
                    old: oldResolved
                }
            );

            pendingAction = function() {
                if (clearResolvedComplaints()) {
                    alert(`${resolvedComplaints.length} resolved complaints have been cleared.`);
                    loadAnalytics();
                }
            };
        }

        function clearOldComplaintsWithConfirm(days) {
            const complaints = getComplaints();
            const cutoffDate = new Date();
            cutoffDate.setDate(cutoffDate.getDate() - days);
            const oldComplaints = complaints.filter(c => new Date(c.createdAt) < cutoffDate);
            const resolvedOld = oldComplaints.filter(c => ['Resolved', 'Closed'].includes(c.status)).length;

            if (oldComplaints.length === 0) {
                alert(`There are no complaints older than ${days} days.`);
                return;
            }

            showModal(
                `Are you sure you want to delete ${oldComplaints.length} complaints older than ${days} days?`,
                true, {
                    total: oldComplaints.length,
                    resolved: resolvedOld,
                    old: oldComplaints.length
                }
            );

            pendingAction = function() {
                if (clearOldComplaints(days)) {
                    alert(`${oldComplaints.length} old complaints have been cleared.`);
                    loadAnalytics();
                }
            };
        }

        function resetDatabaseWithConfirm() {
            showModal(
                'WARNING: This will reset ALL data including users, complaints, and messages. The system will be restored to its initial state. Continue?'
            );

            pendingAction = function() {
                if (resetDatabase()) {
                    alert('Database has been reset to initial state. You will be redirected to the login page.');
                    // Redirect to login page after reset
                    setTimeout(() => {
                        sessionStorage.removeItem('currentUser');
                        window.location.href = 'index.html';
                    }, 2000);
                }
            };
        }

        // Database functions (these should be in database.js)
        function clearAllComplaints() {
            localStorage.setItem('hostel_complaints', JSON.stringify([]));
            return true;
        }

        function clearResolvedComplaints() {
            const complaints = getComplaints();
            const unresolvedComplaints = complaints.filter(c => !['Resolved', 'Closed'].includes(c.status));
            localStorage.setItem('hostel_complaints', JSON.stringify(unresolvedComplaints));
            return true;
        }

        function clearOldComplaints(days) {
            const cutoffDate = new Date();
            cutoffDate.setDate(cutoffDate.getDate() - days);

            const complaints = getComplaints();
            const recentComplaints = complaints.filter(c => new Date(c.createdAt) >= cutoffDate);
            localStorage.setItem('hostel_complaints', JSON.stringify(recentComplaints));
            return true;
        }

        function resetDatabase() {
            localStorage.removeItem('hostel_users');
            localStorage.removeItem('hostel_complaints');
            localStorage.removeItem('hostel_messages');
            localStorage.removeItem('hostel_analytics');
            initDatabase(); // Reinitialize with sample data
            return true;
        }
    </script>
</body>

</html>